<main class="container mx-auto p-4 sm:p-6 lg:p-8">
  <!-- Header -->
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227l.22-.084c.485-.175.988-.22 1.48-.142l.496.095c.46.088.896.347 1.226.745l.214.269c.33.416.516.92.516 1.446l-.002.574c.002.523-.18 1.033-.504 1.446l-.214.27c-.33.398-.766.657-1.226.745l-.496.095c-.492.078-.995.033-1.48-.142l-.22-.084a1.884 1.884 0 01-1.11-1.227l-.078-.428.078-.427.078-.427zM6.657 18c-1.232 0-2.23-1-2.23-2.23s1-2.23 2.23-2.23c1.232 0 2.23 1 2.23 2.23S7.89 18 6.657 18zM17.343 18c-1.232 0-2.23-1-2.23-2.23s1-2.23 2.23-2.23c1.232 0 2.23 1 2.23 2.23S18.575 18 17.343 18zM12 11.23c-1.232 0-2.23-1-2.23-2.23s1-2.23 2.23-2.23c1.232 0 2.23 1 2.23 2.23S13.232 11.23 12 11.23z" />
      </svg>
      Admin Panel
    </h1>
    <p class="mt-1 text-gray-500">Manage master data for the IT Operations Hub.</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Left Column: Manage Master Activities -->
    <div class="lg:col-span-2 space-y-6">
      <div class="bg-white rounded-lg shadow-md">
        <div class="p-5 border-b flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-700">Manage Master Activities</h2>
          <button (click)="exportMasterActivities()" class="p-1 text-gray-500 hover:text-green-600" title="Download CSV">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
          </button>
        </div>
        <div class="p-5">
          <div class="overflow-x-auto max-h-96">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-3">Name</th>
                  <th class="px-4 py-3">Category</th>
                  <th class="px-4 py-3">Default Frequency</th>
                  <th class="px-4 py-3 text-right">Default Hours</th>
                </tr>
              </thead>
              <tbody>
                @for(activity of masterActivities(); track activity.id) {
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900">{{ activity.name }}</td>
                    <td class="px-4 py-3 text-gray-600">{{ activity.category }}</td>
                    <td class="px-4 py-3 text-gray-600">{{ activity.defaultFrequency }}</td>
                    <td class="px-4 py-3 text-right text-gray-600">{{ activity.defaultHrsPerInstance | number: '1.1-1' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md">
        <div class="p-5 border-b">
          <h2 class="text-xl font-bold text-gray-700">Review Activity Suggestions</h2>
        </div>
        <div class="p-5">
           @if (pendingSuggestions().length > 0) {
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Pending Review</h3>
            <div class="space-y-3 mb-6">
              @for(suggestion of pendingSuggestions(); track suggestion.id) {
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                   <p class="font-semibold text-yellow-900">{{ suggestion.suggestedName }} <span class="text-xs font-normal">in</span> {{ suggestion.category }}</p>
                   <p class="text-sm text-yellow-800 italic mt-1">"{{ suggestion.justification }}"</p>
                   <div class="text-xs text-gray-500 mt-2 flex justify-between items-center">
                     <span>Submitted by {{ suggestion.submittedBy }} on {{ suggestion.dateSubmitted | date: 'short' }}</span>
                     <div class="flex gap-2">
                        <button (click)="approve(suggestion.id)" class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">Approve</button>
                        <button (click)="reject(suggestion.id)" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Reject</button>
                     </div>
                   </div>
                </div>
              }
            </div>
           }
           @if (reviewedSuggestions().length > 0) {
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Reviewed History</h3>
            <div class="space-y-2 text-sm max-h-60 overflow-y-auto">
              @for(suggestion of reviewedSuggestions(); track suggestion.id) {
                <div class="flex justify-between items-center p-2 rounded-md" [class]="suggestion.status === 'approved' ? 'bg-green-50' : 'bg-red-50'">
                  <div>
                    <p class="font-medium text-gray-700">{{ suggestion.suggestedName }}</p>
                    <p class="text-xs text-gray-500">{{ suggestion.category }} - {{ suggestion.dateSubmitted | date: 'short' }}</p>
                  </div>
                  <span class="text-xs font-bold px-2 py-1 rounded-full" [class]="getStatusClass(suggestion.status)">{{ suggestion.status | uppercase }}</span>
                </div>
              }
            </div>
           }
        </div>
      </div>

      <!-- Support Group Configuration Card -->
      <div class="bg-white rounded-lg shadow-md">
        <div class="p-5 border-b">
          <h2 class="text-xl font-bold text-gray-700">Support Group Configuration</h2>
          <p class="text-sm text-gray-500 mt-1">Assign L1, L2, and L3 support groups for each portfolio and application.</p>
        </div>
        <div class="p-5 space-y-6">
          @for(portfolio of supportGroupConfigs(); track portfolio.id) {
            <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
              <h3 class="font-bold text-lg text-blue-700">{{ portfolio.name }}</h3>
              <p class="text-xs text-gray-500 mb-3">Default groups for this portfolio.</p>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4">
                <div>
                  <label [for]="portfolio.id + '-l1'" class="block text-sm font-medium text-gray-600">L1 Support Group</label>
                  <input type="text" [id]="portfolio.id + '-l1'"
                        class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900"
                        [value]="portfolio.supportGroups.l1"
                        (input)="onSupportGroupChange(portfolio.id, null, 'l1', $event)">
                </div>
                <div>
                  <label [for]="portfolio.id + '-l2'" class="block text-sm font-medium text-gray-600">L2 Support Group</label>
                  <input type="text" [id]="portfolio.id + '-l2'"
                        class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900"
                        [value]="portfolio.supportGroups.l2"
                        (input)="onSupportGroupChange(portfolio.id, null, 'l2', $event)">
                </div>
                <div>
                  <label [for]="portfolio.id + '-l3'" class="block text-sm font-medium text-gray-600">L3 Support Group</label>
                  <input type="text" [id]="portfolio.id + '-l3'"
                        class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900"
                        [value]="portfolio.supportGroups.l3"
                        (input)="onSupportGroupChange(portfolio.id, null, 'l3', $event)">
                </div>
              </div>

              <h4 class="font-semibold text-gray-800">Application Overrides</h4>
              <div class="space-y-3 mt-2">
                @for(app of portfolio.applications; track app.id) {
                  <div>
                    <p class="font-medium text-gray-700">{{ app.name }}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-1">
                      <div>
                        <input type="text" [id]="app.id + '-l1'"
                              class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900 placeholder-gray-400"
                              [value]="app.supportGroups?.l1 || ''"
                              [placeholder]="portfolio.supportGroups.l1 + ' (Inherited)'"
                              (input)="onSupportGroupChange(portfolio.id, app.id, 'l1', $event)">
                      </div>
                      <div>
                        <input type="text" [id]="app.id + '-l2'"
                              class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900 placeholder-gray-400"
                              [value]="app.supportGroups?.l2 || ''"
                              [placeholder]="portfolio.supportGroups.l2 + ' (Inherited)'"
                              (input)="onSupportGroupChange(portfolio.id, app.id, 'l2', $event)">
                      </div>
                      <div>
                        <input type="text" [id]="app.id + '-l3'"
                              class="mt-1 block w-full text-sm border-gray-300 rounded-md shadow-sm bg-white text-gray-900 placeholder-gray-400"
                              [value]="app.supportGroups?.l3 || ''"
                              [placeholder]="portfolio.supportGroups.l3 + ' (Inherited)'"
                              (input)="onSupportGroupChange(portfolio.id, app.id, 'l3', $event)">
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

       <!-- SLA Timings Configuration Card -->
      <div class="bg-white rounded-lg shadow-md">
        <div class="p-5 border-b flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-700">SLA Timings Configuration</h2>
        </div>
        <div class="p-5">
          <form [formGroup]="slaForm" (ngSubmit)="saveSlaConfigs()">
            <div formArrayName="configs" class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left">Priority</th>
                    <th class="px-4 py-3 text-left w-2/5">Description</th>
                    <th class="px-4 py-3 text-left">SLA Value</th>
                    <th class="px-4 py-3 text-left">Unit</th>
                    <th class="px-4 py-3 text-center">Business Hours Only</th>
                  </tr>
                </thead>
                <tbody>
                  @for (configGroup of slaConfigsArray.controls; track configGroup; let i = $index) {
                    <tr [formGroupName]="i" class="border-b">
                      <td class="px-4 py-3 font-bold text-gray-800">{{ slaConfigs()[i].priority }}</td>
                      <td class="px-4 py-3">
                        <input type="text" formControlName="description" class="w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
                      </td>
                      <td class="px-4 py-3">
                        <input type="number" formControlName="value" class="w-24 border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
                      </td>
                      <td class="px-4 py-3">
                        <select formControlName="unit" class="border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
                          <option value="hours">Hours</option>
                          <option value="days">Days</option>
                        </select>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <input type="checkbox" formControlName="businessHoursOnly" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
            <div class="mt-6 flex justify-end items-center gap-4">
              @if (slaSaveStatus() === 'saved') {
                <span class="text-sm font-medium text-green-600">Changes saved successfully!</span>
              }
              <button type="submit" [disabled]="slaForm.invalid || slaSaveStatus() === 'saving'" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                {{ slaSaveStatus() === 'saving' ? 'Saving...' : 'Save SLA Settings' }}
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>

    <!-- Right Column: Forms -->
    <div class="lg:col-span-1 space-y-6">
      <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
        <h2 class="text-xl font-bold text-gray-700 mb-4">FTE Calculation Settings</h2>
        <div class="space-y-4">
          <div>
            <label for="fteModel" class="block text-sm font-medium text-gray-700">Ticket-Driven Work Model</label>
            <select id="fteModel" [value]="fteCalculationModel()" (change)="onFteModelChange($event)" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white text-gray-900">
              @for(model of fteModels; track model) {
                <option [value]="model">{{ model }}</option>
              }
            </select>
             <p class="mt-2 text-xs text-gray-500">{{ modelDescription() }}</p>
          </div>
        </div>
      </div>
      
       <!-- Watchtower Data Source Card -->
      <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
        <h2 class="text-xl font-bold text-gray-700 mb-2">Watchtower Data Source</h2>
        <p class="text-sm text-gray-600 mb-4">Configure your backend to use the following Databricks SQL query to populate the SLA Watchtower dashboard.</p>
        <div class="relative bg-gray-800 p-4 rounded-md mt-2">
          <pre><code class="language-sql text-sm text-gray-300 whitespace-pre-wrap">{{ databricksQuery }}</code></pre>
          <button (click)="copyDatabricksQuery()" class="absolute top-3 right-3 bg-gray-700 text-gray-300 hover:bg-gray-600 px-3 py-1 rounded text-xs font-medium flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            {{ copiedQuery() ? 'Copied!' : 'Copy' }}
          </button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
        <h2 class="text-xl font-bold text-gray-700 mb-4">Add New Master Activity</h2>
        <form [formGroup]="activityForm" (ngSubmit)="addMasterActivity()" class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Activity Name</label>
            <input type="text" id="name" formControlName="name" 
                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900"
                   [class]="activityForm.get('name')?.invalid && activityForm.get('name')?.touched ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : 'focus:border-blue-500 focus:ring-blue-500'">
            @if (activityForm.get('name')?.invalid && activityForm.get('name')?.touched) {
              <p class="mt-1 text-xs text-red-600">
                @if (activityForm.get('name')?.hasError('required')) {
                  Activity name is required.
                }
              </p>
            }
          </div>
           <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
            <select id="category" formControlName="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white text-gray-900">
              @for(cat of activityCategories; track cat) {
                <option [value]="cat">{{ cat }}</option>
              }
            </select>
          </div>
          <div>
            <label for="defaultFrequency" class="block text-sm font-medium text-gray-700">Default Frequency</label>
            <select id="defaultFrequency" formControlName="defaultFrequency" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white text-gray-900">
              @for(freq of frequencies; track freq) {
                <option [value]="freq">{{ freq }}</option>
              }
            </select>
          </div>
           <div>
            <label for="defaultHrsPerInstance" class="block text-sm font-medium text-gray-700">Default Hours / Instance</label>
            <input type="number" id="defaultHrsPerInstance" formControlName="defaultHrsPerInstance" step="0.1"
                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900"
                   [class]="activityForm.get('defaultHrsPerInstance')?.invalid && activityForm.get('defaultHrsPerInstance')?.touched ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : 'focus:border-blue-500 focus:ring-blue-500'">
            @if (activityForm.get('defaultHrsPerInstance')?.invalid && activityForm.get('defaultHrsPerInstance')?.touched) {
              <p class="mt-1 text-xs text-red-600">
                @if (activityForm.get('defaultHrsPerInstance')?.hasError('required')) {
                  Hours are required.
                }
                @if (activityForm.get('defaultHrsPerInstance')?.hasError('min')) {
                  Hours must be a positive number.
                }
              </p>
            }
          </div>
          
          @if (activityForm.hasError('duplicateActivity') && (activityForm.get('name')?.touched || activityForm.get('category')?.touched)) {
            <div class="text-xs text-red-600 p-2 bg-red-50 rounded-md text-center">
              An activity with this name already exists in the selected category.
            </div>
          }
          
          <div>
            <button type="submit" [disabled]="activityForm.invalid" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
              Add Activity
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</main>