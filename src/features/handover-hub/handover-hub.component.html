<main class="h-[calc(100vh-80px)] flex">
  <!-- Sidebar for Portfolios -->
  <aside class="w-1/4 bg-white border-r border-gray-200 p-4 flex flex-col">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Portfolios</h2>
    <div class="flex-grow space-y-2">
      @for (portfolio of portfolios(); track portfolio.id) {
        <button 
          (click)="selectPortfolio(portfolio.id)"
          class="w-full text-left p-3 rounded-lg flex items-center justify-between transition-colors duration-200"
          [class]="activePortfolioId() === portfolio.id ? 'bg-blue-100 text-blue-800' : 'text-gray-600 hover:bg-gray-100'">
          <span class="font-semibold">{{ portfolio.name }}</span>
          <span class="w-3 h-3 rounded-full" [class]="getHealthClass(portfolio.health)"></span>
        </button>
      }
    </div>
    <div class="mt-4 pt-4 border-t space-y-2">
      <button (click)="openEmailModal()" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
        Compose & Send EOD Email
      </button>
      <button (click)="archiveHandovers()" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v2a2 2 0 01-2-2H7a2 2 0 01-2-2V4zM5 9a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2H5z" /></svg>
        Archive Daily Handover
      </button>
    </div>
  </aside>

  <!-- Main Content Area -->
  <div class="w-3/4 bg-gray-50 overflow-y-auto p-6">
    <!-- View Toggles -->
    <div class="mb-4 border-b border-gray-200">
      <nav class="-mb-px flex space-x-6" aria-label="Tabs">
        <button (click)="activeView.set('live')" 
          [class]="activeView() === 'live' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" 
          class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
          Live Handover
        </button>
        <button (click)="activeView.set('history')" 
          [class]="activeView() === 'history' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" 
          class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
          History & Effectiveness
        </button>
      </nav>
    </div>

    @if (activeView() === 'live') {
      <div class="max-w-4xl mx-auto">
        @if (activePortfolio(); as portfolio) {
          <!-- Header -->
          <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center gap-3">
              {{ portfolio.name }} Handover
              <span class="text-xs font-semibold px-2.5 py-1 rounded-full text-white" [class]="getHealthClass(portfolio.health)">{{ portfolio.health }}</span>
            </h1>
            <p class="mt-1 text-gray-500">A consolidated view of notes and incident progress for a seamless shift transition.</p>
          </header>
          <!-- Handover Notes -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Onshore to Offshore -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200">
              <div class="p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800 flex items-center justify-between w-full">
                  <span class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM5.05 5.05a.75.75 0 011.06 0l1.062 1.06a.75.75 0 01-1.06 1.06L5.05 6.11a.75.75 0 010-1.06zM2 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 012 10zM5.05 14.95a.75.75 0 010-1.06l1.06-1.062a.75.75 0 011.06 1.06L6.11 14.95a.75.75 0 01-1.06 0zM10 18a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5A.75.75 0 0110 18zM14.95 14.95a.75.75 0 01-1.06 0l-1.06-1.06a.75.75 0 011.06-1.06l1.06 1.06a.75.75 0 010 1.06zM18 10a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0118 10zM14.95 5.05a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 01-1.06-1.06L13.89 5.05a.75.75 0 011.06 0z" /></svg>
                    Onshore to Offshore (EOD)
                  </span>
                  <button (click)="generateEodNotes()" [disabled]="isGeneratingEodNotes()" class="text-xs font-semibold text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-wait flex items-center gap-1.5 px-2 py-1 rounded-md bg-blue-50 hover:bg-blue-100 disabled:bg-gray-100">
                    @if (isGeneratingEodNotes()) {
                      <svg class="animate-spin h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      <span>Generating...</span>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v2.879a.5.5 0 01-.146.353l-2.122 2.121a.5.5 0 00-.146.354V13a1 1 0 01-1 1h-2a1 1 0 01-1-1V8.207a.5.5 0 00-.146-.354L5.146 5.732A.5.5 0 015 5.379V2.5zM3.5 14.5A1.5 1.5 0 015 13h10a1.5 1.5 0 011.5 1.5v1a1.5 1.5 0 01-1.5 1.5H5A1.5 1.5 0 013.5 16v-1.5z" clip-rule="evenodd" /></svg>
                      <span>Generate Notes with Strider AI</span>
                    }
                  </button>
                </h3>
              </div>
              <div class="p-4">
                <textarea class="w-full h-48 p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-900 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter end-of-day summary, tasks to be monitored, and any special instructions..." [value]="handoverData().onshoreToOffshore" (change)="onNotesChange('onshore', $event)"></textarea>
              </div>
            </div>
            <!-- Offshore to Onshore -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200">
              <div class="p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                  Offshore to Onshore (BOD)
                </h3>
              </div>
              <div class="p-4">
                <textarea class="w-full h-48 p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-900 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter beginning-of-day summary, actions taken overnight, and items for the onshore team to pick up..." [value]="handoverData().offshoreToOnshore" (change)="onNotesChange('offshore', $event)"></textarea>
              </div>
            </div>
          </div>
          <!-- Active Incidents Handover -->
          <div>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Active Incidents Handover</h2>
            @if (activeIncidents().length > 0) {
              <div class="space-y-4">
                @for (incident of activeIncidents(); track incident.id) {
                  <div class="rounded-lg shadow-md overflow-hidden border border-gray-200">
                    <app-incident-handover-card [incident]="incident"></app-incident-handover-card>
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
                      <div class="flex justify-between items-center mb-2">
                        <label [for]="'gist-' + incident.id" class="text-sm font-semibold text-gray-700 block">Progress Gist & Handover Notes</label>
                        <button (click)="generateGist(incident)" [disabled]="generatingGistFor() === incident.id" class="text-xs font-semibold text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-wait flex items-center gap-1.5 px-2 py-1 rounded-md bg-blue-50 hover:bg-blue-100 disabled:bg-gray-100">
                           @if (generatingGistFor() === incident.id) {
                            <svg class="animate-spin h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>Generating...</span>
                           } @else {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2.5a.5.5 0 01.5-.5h8a.5.5 0 01.5.5v2.879a.5.5 0 01-.146.353l-2.122 2.121a.5.5 0 00-.146.354V13a1 1 0 01-1 1h-2a1 1 0 01-1-1V8.207a.5.5 0 00-.146-.354L5.146 5.732A.5.5 0 015 5.379V2.5zM3.5 14.5A1.5 1.5 0 015 13h10a1.5 1.5 0 011.5 1.5v1a1.5 1.5 0 01-1.5 1.5H5A1.5 1.5 0 013.5 16v-1.5z" clip-rule="evenodd" /></svg>
                            <span>Generate Gist</span>
                           }
                        </button>
                      </div>
                      <textarea [id]="'gist-' + incident.id" class="w-full p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-900 focus:ring-blue-500 focus:border-blue-500" placeholder="Summarize the latest progress and next steps for this incident..." rows="2" [value]="handoverData().incidentGists[incident.id] || ''" (change)="onGistChange(incident.id, $event)"></textarea>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-center py-10 bg-white rounded-lg border border-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <p class="mt-2 font-semibold text-gray-700">No active incidents for this portfolio.</p>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-20">
            <p class="text-gray-500">Please select a portfolio to view its handover details.</p>
          </div>
        }
      </div>
    }

    @if (activeView() === 'history') {
      <div class="max-w-4xl mx-auto">
        <header class="mb-6 flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-extrabold text-gray-900">Handover History</h1>
            <p class="mt-1 text-gray-500">Review past handovers and track effectiveness.</p>
          </div>
          <div class="flex items-center gap-2">
            <label for="history-date" class="text-sm font-medium text-gray-700">Select Date:</label>
            <input type="date" id="history-date" [value]="selectedHistoryDate()" (change)="onDateChange($event)" class="border-gray-300 rounded-md shadow-sm text-sm bg-white text-gray-900">
          </div>
        </header>

        @if (historyForDate().length > 0) {
          <div class="space-y-8">
            @for (item of historyForDate(); track item.id) {
              <div class="bg-white rounded-lg shadow-md border border-gray-200">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                  <h2 class="text-xl font-bold text-gray-800">{{ item.portfolioName }}</h2>
                  <span class="text-xs font-semibold px-2.5 py-1 rounded-full text-white" [class]="getHealthClass(item.portfolioHealth)">{{ item.portfolioHealth }}</span>
                </div>
                
                <!-- Notes -->
                <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                     <h3 class="font-semibold text-gray-700 mb-2">Onshore to Offshore (EOD)</h3>
                     <p class="text-sm text-gray-600 whitespace-pre-wrap bg-gray-50 p-3 rounded-md h-32 overflow-y-auto">{{ item.notes.onshoreToOffshore }}</p>
                  </div>
                   <div>
                     <h3 class="font-semibold text-gray-700 mb-2">Offshore to Onshore (BOD)</h3>
                     <p class="text-sm text-gray-600 whitespace-pre-wrap bg-gray-50 p-3 rounded-md h-32 overflow-y-auto">{{ item.notes.offshoreToOnshore || 'No notes provided.' }}</p>
                  </div>
                </div>

                <!-- Gists -->
                @if (Object.keys(item.notes.incidentGists).length > 0) {
                  <div class="p-4 border-t">
                    <h3 class="font-semibold text-gray-700 mb-2">Incident Gists</h3>
                    <div class="space-y-2">
                       @for (key of Object.keys(item.notes.incidentGists); track key) {
                        <div class="text-sm">
                          <span class="font-semibold text-gray-800">{{key}}:</span>
                          <span class="text-gray-600 italic">"{{ item.notes.incidentGists[key] }}"</span>
                        </div>
                       }
                    </div>
                  </div>
                }

                <!-- Manager Feedback -->
                <div class="p-4 border-t bg-blue-50/50">
                  <h3 class="font-bold text-blue-800 mb-3">Manager Feedback & Effectiveness</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Rate this handover:</label>
                      <app-star-rating [rating]="item.feedback.rating" (ratingChange)="onRatingChange(item.id, $event)"></app-star-rating>
                      <p class="text-xs text-gray-500 mt-1">Click a star to set a new rating.</p>
                    </div>
                    <div class="space-y-2">
                       <textarea class="w-full p-2 border border-gray-300 rounded-md text-sm bg-white text-gray-900 focus:ring-blue-500 focus:border-blue-500" 
                          placeholder="Add feedback comment..."
                          [value]="feedbackComments()[item.id] ?? item.feedback.comment"
                          (input)="onFeedbackCommentInput(item.id, $event)"
                          rows="3"></textarea>
                       <button (click)="submitFeedback(item)" class="w-full md:w-auto float-right px-3 py-1.5 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700">Save Feedback</button>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
           <div class="text-center py-20 bg-white rounded-lg border border-dashed">
              <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
              <p class="mt-2 font-semibold text-gray-700">No handover records found for this date.</p>
              <p class="text-sm text-gray-500">Try selecting another date or archiving the current day's handover.</p>
            </div>
        }
      </div>
    }
  </div>
</main>

<!-- Email Composition Modal -->
@if (isEmailModalOpen()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" (click)="isEmailModalOpen.set(false)">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl" (click)="$event.stopPropagation()">
      <form [formGroup]="emailForm" (ngSubmit)="sendEmail()">
        <div class="p-4 border-b">
          <h2 class="text-xl font-bold text-gray-800">Compose EOD Handover Email</h2>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label for="email-to" class="block text-sm font-medium text-gray-700">To</label>
            <input type="email" id="email-to" formControlName="to" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
          </div>
          <div>
            <label for="email-cc" class="block text-sm font-medium text-gray-700">CC</label>
            <input type="email" id="email-cc" formControlName="cc" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
          </div>
           <div>
            <label for="email-subject" class="block text-sm font-medium text-gray-700">Subject</label>
            <input type="text" id="email-subject" formControlName="subject" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-500">
          </div>
          <div>
            <label for="email-body" class="block text-sm font-medium text-gray-700">Body</label>
            <textarea id="email-body" formControlName="body" rows="10" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm sm:text-sm bg-white text-gray-900 font-mono text-xs"></textarea>
          </div>
        </div>
        <div class="px-6 py-3 bg-gray-50 flex justify-end gap-3">
          <button type="button" (click)="isEmailModalOpen.set(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
          <button type="submit" [disabled]="emailForm.invalid" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400">Log and Send Email</button>
        </div>
      </form>
    </div>
  </div>
}
