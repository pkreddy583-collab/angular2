<main class="p-4 sm:p-6 lg:p-8">
  @if (incident(); as incident) {
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 sm:p-8">
      
      <!-- Incident Header -->
      <div>
        <h1 class="text-lg font-bold text-blue-600">Incident Details</h1>
        <div class="w-16 h-1 bg-blue-600 rounded-full mt-2"></div>
        <p class="mt-4 text-3xl font-bold text-gray-800">
          {{ incident.id }}: {{ incident.title }}
        </p>
      </div>

      <!-- Incident Description -->
      <div class="mt-6">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Description</h2>
        <p class="mt-2 text-gray-700 leading-relaxed">
          {{ incident.description }}
        </p>
      </div>

      <!-- Metadata -->
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <h3 class="flex items-center text-sm font-semibold text-gray-500 uppercase tracking-wider">
            <svg class="h-5 w-5 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M11.75 2.75a.75.75 0 01.75.75V4h1.25a.75.75 0 010 1.5H3.25a.75.75 0 010-1.5H4.5V3.5A.75.75 0 015.25 2h6.5a.75.75 0 01.75.75zM4.5 7.5a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM5.25 10a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5H5.25zM3 15a2 2 0 104 0 2 2 0 00-4 0zM6.5 15a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
            </svg>
            Affected Services
          </h3>
          <div class="mt-3 flex flex-wrap gap-2">
            @for(service of incident.affectedServices; track service) {
              <span class="px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                {{ service }}
              </span>
            }
          </div>
        </div>
        <div>
          <h3 class="flex items-center text-sm font-semibold text-gray-500 uppercase tracking-wider">
             <svg class="h-5 w-5 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 2.5a.75.75 0 00-1.5 0v4.69L6.03 12.22a.75.75 0 10.94 1.18l3-2.5a.75.75 0 00.28-.53V4.5a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
            </svg>
            Last Update
          </h3>
          <p class="mt-3 text-gray-700">
            {{ incident.lastUpdate }}
          </p>
        </div>
      </div>
      
      <hr class="my-8 border-gray-200" />

      <!-- AI Co-pilot -->
      <div class="bg-blue-50/70 border border-blue-200 rounded-lg p-6">
        <h2 class="flex items-center text-xl font-bold text-blue-800">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 01-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 013.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 013.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 01-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.456-2.456L12.5 18l1.178-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
          Strider AI Co-pilot
        </h2>
        
        <!-- Tabs -->
        <div class="mt-4 border-b border-gray-200">
          <nav class="-mb-px flex space-x-6" aria-label="Tabs">
            <button (click)="selectTab('Triage')" [class]="activeTab() === 'Triage' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
              <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              Triage
            </button>
            <button (click)="selectTab('Research')" [class]="activeTab() === 'Research' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
              <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
              Research
            </button>
            <button (click)="selectTab('Timeline')" [class]="activeTab() === 'Timeline' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
              <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              Timeline
            </button>
            <button (click)="selectTab('Exec Summary')" [class]="activeTab() === 'Exec Summary' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm flex items-center">
              <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
              Exec Summary
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="pt-6">
          @if (activeTab() === 'Triage') {
            <div class="bg-white p-4 rounded-md border border-gray-200">
              <p class="text-sm text-gray-700 leading-relaxed">
                Based on the error logs and service metrics, the server unresponsiveness is likely due to a critical hardware failure on the primary node. The immediate impact is a complete outage for all hosted services. The top priority is to failover to the secondary node to restore service while the physical inspection is underway.
              </p>
            </div>
          }
          @if (activeTab() === 'Research') {
            <div class="bg-white p-4 rounded-md border border-gray-200">
              <p class="font-semibold text-blue-600">
                KB00202: Optimizing Database Indexing for Search
              </p>
              <p class="text-sm text-gray-600 mt-1">
                Best practices for creating and maintaining database indexes to improve the performance of complex search queries.
              </p>
              <hr class="my-3" />
              <div class="flex items-start">
                <svg class="h-5 w-5 mr-2 text-blue-500 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 01-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 013.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 013.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 01-3.09 3.09z" /></svg>
                <p class="text-sm text-gray-800">
                  <strong class="font-semibold">AI Gist:</strong> This article is relevant because the incident highlights slowness 'especially when accessing payroll information,' which often involves complex database queries that can be improved through indexing to reduce load on the application server and database.
                </p>
              </div>
            </div>
          }
          @if (activeTab() === 'Timeline') {
            <div class="bg-white p-4 rounded-md border border-gray-200">
              <ul class="space-y-3">
                <li class="flex items-start">
                  <div class="w-24 text-sm font-semibold text-gray-600 flex-shrink-0">10:00 AM</div>
                  <div class="text-sm text-gray-800 ml-4">Initial P1 alert received from monitoring for 'Production server unresponsive'.</div>
                </li>
                <li class="flex items-start">
                  <div class="w-24 text-sm font-semibold text-gray-600 flex-shrink-0">10:02 AM</div>
                  <div class="text-sm text-gray-800 ml-4">Automated runbooks for service restart failed to execute.</div>
                </li>
                 <li class="flex items-start">
                  <div class="w-24 text-sm font-semibold text-gray-600 flex-shrink-0">10:05 AM</div>
                  <div class="text-sm text-gray-800 ml-4">Alice, the on-call engineer, was paged and acknowledged the incident.</div>
                </li>
                 <li class="flex items-start">
                  <div class="w-24 text-sm font-semibold text-gray-600 flex-shrink-0">10:15 AM</div>
                  <div class="text-sm text-gray-800 ml-4">Initial investigation points to a possible hardware failure. Awaiting physical inspection.</div>
                </li>
              </ul>
            </div>
          }
           @if (activeTab() === 'Exec Summary') {
            <div class="bg-white p-4 rounded-md border border-gray-200">
              <p class="text-sm text-gray-700 leading-relaxed">
                A critical incident is impacting all production services due to an unresponsive server. The technical team is actively working to restore service by failing over to a backup server. The estimated time to recovery is approximately 30-45 minutes. The root cause appears to be a hardware failure, and further details will be provided once the physical inspection is complete.
              </p>
            </div>
          }
        </div>

        <!-- AI Feedback Module -->
        <div class="mt-6 pt-4 border-t border-blue-200">
          @if (feedbackSubmitted()) {
            <div class="text-center p-4 bg-green-100 text-green-800 rounded-md">
              <p class="font-semibold">Thank you for your feedback!</p>
            </div>
          } @else {
            @if (feedbackHelpful() === null) {
              <div class="flex items-center justify-center gap-4">
                <p class="text-sm font-medium text-gray-700">Was this helpful?</p>
                <button (click)="recordHelpful('yes')" class="p-2 rounded-full hover:bg-green-200 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-1.9 4.5M7 20h2.222a2 2 0 001.735-1.026l.548-1.371c.176-.442.37-1.06.37-1.601V11.25M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" /></svg>
                </button>
                <button (click)="recordHelpful('no')" class="p-2 rounded-full hover:bg-red-200 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.738 3h4.017c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.085a2 2 0 001.736-.97l1.9-4.5M17 4h-2.222a2 2 0 00-1.735 1.026l-.548 1.371c-.176.442-.37 1.06-.37 1.601V12.75M17 4H19a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" /></svg>
                </button>
              </div>
            }
            @if (feedbackHelpful() === 'yes') {
              <div class="flex items-center justify-center gap-4 animate-fade-in">
                <p class="text-sm font-medium text-gray-700">How much time did it save you?</p>
                <div class="flex-grow max-w-xs">
                  <select [formControl]="timeSavedSelection" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white text-gray-900">
                    <option value="<5">&lt; 5 minutes</option>
                    <option value="5-10">5-10 minutes</option>
                    <option value="15-30">15-30 minutes</option>
                    <option value="30+">30+ minutes</option>
                  </select>
                </div>
                <button (click)="submitTimeSavedFeedback()" [disabled]="!timeSavedSelection.value" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 disabled:bg-gray-400">Submit</button>
              </div>
            }
          }
        </div>
      </div>

    </div>
  } @else {
    <div class="text-center py-20">
      <p class="text-gray-500">Loading incident details...</p>
    </div>
  }
</main>